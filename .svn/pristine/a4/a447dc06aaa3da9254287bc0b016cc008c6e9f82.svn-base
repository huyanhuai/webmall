<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>商品页</title>
    <link rel="stylesheet" href="static/css/base.css">
    <link rel="stylesheet" href="static/css/public.css">
    <link rel="stylesheet" href="static/css/hot.css">
    <link rel="stylesheet" href="static/css/goods.css">
    <link rel="stylesheet" href="static/css/package.css">
    <link rel="stylesheet" href="plug-in/swiper/swiper-4.2.0.min.css">
    <style>

        .ticket-info {
            width: 100%;
            height: 10rem;
            background: #fff;
            overflow-y: scroll;
        }

        .ticket-info-head {
            padding-bottom: 0.2rem;
            border-bottom: 0.01rem solid #e5e5e5;
            background: #fff;
        }

        .ticket-provider {
            margin-top: 0.2rem;
        }

        .ticket-info-name {
            font-size: 0.3rem;
            color: #2a2a2a;
            margin-bottom: 0.2rem;
        }

        .ticket-info-box {
            width: 100%;
            height: auto;
            overflow: hidden;
            padding: 0.2rem 0;
            margin-bottom: 1rem;
        }

        .ticket-provider-message {
            width: 100%;
            font-size: 0.26rem;
            color: #7a7a7a;
            text-align: justify;
            line-height: 0.4rem;
        }

        .ticket-info-sure {
            width: 100%;
            height: 0.9rem;
            background-color: #47bfc5;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            display: -webkit-flex;
            -webkit-align-items: center;
            -webkit-justify-content: center;
            font-size: 0.36rem;
            text-align: center;
            position: absolute;
            bottom: 0;
            left: 0;
        }

        #loading p {
            font-size: 0.3rem;
            color: #0e0e0e;
        }

        /*图片轮播*/
        .layui-m-layer * {
            -webkit-box-sizing: border-box !important;
            -moz-box-sizing: border-box !important;
            box-sizing: border-box !important;
        }

        .layui-m-layercont {
            width: 100%;
            height: 100%;
            display: flex;
            display: -webkit-flex;
            align-items: center;
            -webkit-align-items: center;
            justify-content: center;
            -webkit-justify-content: center;
            flex-direction: column;
            -webkit-flex-direction: column;
        }

        .close {
            margin-top: 1rem;
        }

        .goods-img .swiper-container {
            width: 100%;
            height: 40%;
        }

        .goods-img .swiper-pagination {
            font-size: 0.3rem;
            color: #fff;
        }

        .goods-img .swiper-slide img {
            width: 100%;
            height: 100%;
        }

        #indexMall {
            right: 0;
            left: 0.2rem;
        }
    </style>
</head>
<body>
<main style="margin: 0;">
    <div id="goodsCon">
        <div class="banner">
            <div class="nav">
                <img src="static/img/goods/return@2x.png" alt="" class="return" onclick="returnBack()">
                <img src="static/img/goods/endorsement.png" alt="" class="share">
                <img src="static/img/goods/collection@2x.png" alt="" class="collection" onclick="currentCollect(this)"
                     id="currentCollectFlag">
            </div>
            <div class="swiper-container">
                <div class="swiper-wrapper" id="goodsImg">

                </div>
            </div>
        </div>
        <div class="scenic-detail" onclick="jumpProductDetail()">
            <div class="scenic-detail-left">
                <p>
                    <img src="static/img/goods/scenicspot@2x.png" alt="">
                    <span id="productBaseName"></span>
                </p>
                <p id="productBaseInfo"></p>
            </div>
            <div class="scenic-detail-right">
                <a href="javascript:;">
                    <img src="static/img/goods/details@2x.png" alt="">
                </a>
            </div>
        </div>
        <div class="scenic-address" id="navAddress">
            <a href="javascript:;">
                <img src="static/img/goods/address@2x.png" alt="" class="icon">
                <span id="productBaseAdd"></span>
                <img src="static/img/goods/details@2x.png" alt="" class="more">
            </a>
        </div>
        <section id="package">
            <div class="ticket-box">
                <div class="ticket-head">
                    <img src="static/img/goods/ticket@2x.png" alt="" class="icon">
                    门票
                    <img src="static/img/goods/shangla.png" alt="" class="arrow">
                </div>
                <div class="ticket-con">

                </div>
            </div>
        </section>
        <section>
            <div class="recommend">
                <div class="recommend-head">
                    <a>同类推荐</a>
                    <a href="" id="moreSimilar">
                        更多
                        <img src="static/img/goods/details@2x.png" alt="">
                    </a>
                </div>
                <div class="recommend-con" id="similarProduct">

                </div>
            </div>
        </section>
        <section>
            <div class="recommend">
                <div class="recommend-head">
                    <a>附近推荐</a>
                    <a href="" id="moreNear">
                        更多
                        <img src="static/img/goods/details@2x.png" alt="">
                    </a>
                </div>
                <div class="recommend-con" id="nearProduct">

                </div>
            </div>
        </section>
    </div>
</main>
<div id="shareImgBox">
    <div id="shareImg">
        <img src="" alt="" crossOrigin="anonymous">
        <!--<div id="qrcode"></div>-->
    </div>
    <div id="shareQCode">
        <div class="shareQ-left">
            <img src="" alt="" id="shareHeadImg" crossOrigin="anonymous">
            <span id="shareName"></span>
            <span>邀您同游</span>
        </div>
        <div class="shareQ-right">
            <div id="qrcode"></div>
            <p>扫描二维码，立即购买</p>
        </div>
        <!--<span>微信扫一扫即可购买</span>-->
    </div>
</div>
<!--海报加载-->
<div id="loading" style="background-color: rgba(0,0,0,.7);">
    <p style="color: #fff">海报生成中......</p>
</div>
<!--前往首页的悬浮窗-->
<a id="indexMall" href="index.html" style="display: none">
    <img src="static/img/public/indexMall.png" alt="">
</a>
</body>
</html>
<script src="static/js/jquery-3.2.1.min.js"></script>
<script src="static/js/public.js"></script>
<script src="static/js/ajaxTool.js"></script>
<script src="static/js/localStorage.js"></script>
<script src="plug-in/swiper/swiper-4.2.0.min.js"></script>
<script src="plug-in/layer_mobile/layer.js"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
<script src="static/js/history.js"></script>
<script type="text/javascript" src="static/js/html2canvas.min.js"></script>
<script type="text/javascript" src="static/js/qrcode.min.js?ver=20110905"></script>

<script>
    var latitude, longitude, provinceName, address;
    var productId;          //产品Id
    var productCategoryId;  //产品分类id

    //定义用来分享所用的变量
    var sharProductName, sharProductTitle, sharPicture, shareUrl;
    var coverImg;   //海报的图片

    var clientId, endId;       //接受app传送过来的
    var clientType;             //接受app传送过来的

    var starsLevel = 5;   //星星最高等级_评分
    var str = "您还未绑定手机号，分享将无法获取佣金，绑定后分享成交订单才有奖励可拿哦！请前往个人中心进行手机号绑定";
    var token, isMobile = true;
    $(function () {
        //获取身份iid
        clientId = GetQueryString("clientId");
        endId = GetQueryString("endId");
        //获取身份
        clientType = GetQueryString("clientType");
        //获取产品Id
        productId = GetQueryString("productId");

        if (clientId != null) {
            $("#indexMall").show();
        }

        if (clientType) {//这个是ios要嵌套的页面
            // $("#clientHead").hide();
            // $("#clientFoot").hide();
        } else {//这是正常的
            getToken();     //只能在这里获取（否则ios嵌套会有问题）
            var token = getLocal("token");
            $.ajax({
                beforeSend: function (xhr) {
                    //发送ajax请求之前向http的head里面加入验证信息
                    xhr.setRequestHeader("token", token); // 请求发起前在头部附加token
                },
                url: baseAjaxUrl + '/ty_api/user/getDetail',
                type: "POST",
                sync: false,
                success: function (res) {
                    if (res.errorCode == 200) {
                        //平台业务员身份的分享
                        var headImg = baseImgUrl + res.data.headImg + ".jpg";
                        $("#shareName").html("[" + res.data.nickName + "]");
                        $("#shareHeadImg").attr("src", headImg);

                        if (clientId == null) {
                            shareUrl = oneselfUrl + "goods.html?clientId=" + res.data.userId + "&type=PRODUCT_CODE_URL" + "&productId=" + productId;
                        } else {
                            shareUrl = oneselfUrl + "goods.html?clientId=" + clientId + "&type=PRODUCT_CODE_URL" + "&productId=" + productId + "&endId=" + res.data.userId;
                        }

                        //此处验证是否绑定手机号，用于合并微信和ios的账户数据
                        if (res.data.mobile == null) {
                            isMobile = false;
                        }

                        //海报的二维码
                        var qrcode = new QRCode('qrcode', {
                            text: shareUrl,
                            width: 80,
                            height: 80,
                            colorDark: '#000000',
                            colorLight: '#ffffff',
                            correctLevel: QRCode.CorrectLevel.L
                        });
                    }
                }
            });


        }

        //微信相关设置分享
        $.ajax({
            url: baseAjaxUrl + "/wechatController/getSignature",
            type: "POST",
            data: {requestUrl: window.location.href},
            success: function (e) {
                if (e.errorCode == 200) {

                    var data = e.data;
                    wx.config({
                        debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                        appId: data.appId, // 必填，公众号的唯一标识
                        timestamp: data.timestamp, // 必填，生成签名的时间戳
                        nonceStr: data.noncestr, // 必填，生成签名的随机串
                        signature: data.signature,// 必填，签名
                        jsApiList: [
                            // 所有要调用的 API 都要加到这个列表中
                            'checkJsApi',
                            'onMenuShareTimeline',       // 分享到朋友圈接口
                            'onMenuShareAppMessage',  //  分享到朋友接口
                            'onMenuShareQQ',         // 分享到QQ接口
                            'onMenuShareWeibo',      // 分享到微博接口
                            'onMenuShareQZone',     //分享到QQ空间] // 必填，需要使用的JS接口列表
                            'getLocation',
                            'openLocation'
                        ]
                    });
                }
            }
        });
        wx.ready(function () {

            wx.checkJsApi({
                jsApiList: [
                    'checkJsApi',
                    'onMenuShareTimeline',       // 分享到朋友圈接口
                    'onMenuShareAppMessage',  //  分享到朋友接口
                    'onMenuShareQQ',         // 分享到QQ接口
                    'onMenuShareWeibo',      // 分享到微博接口
                    'onMenuShareQZone',     //分享到QQ空间] // 必填，需要使用的JS接口列表
                    'getLocation',
                    'openLocation'
                ], // 需要检测的JS接口列表，所有JS接口列表见附录2,
                success: function (res) {
                    // 以键值对的形式返回，可用的api值true，不可用为false
                    // 如：{"checkResult":{"chooseImage":true},"errMsg":"checkJsApi:ok"}
                }
            });

            //微信分享
            var shareData = {
                title: sharProductName, // 分享标题
                desc: sharProductTitle, // 分享描述
                link: shareUrl, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                imgUrl: sharPicture, // 分享图标
                type: '', // 分享类型,music、video或link，不填默认为link
                dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
                trigger: function (res) {
                    // 不要尝试在trigger中使用ajax异步请求修改本次分享的内容，因为客户端分享操作是一个同步操作，这时候使用ajax的回包会还没有返回

                    if (!isMobile) {
                        alert(str);
                    }

                },
                success: function () {
                    // 用户确认分享后执行的回调函数
                    console.log(sharPicture)
                },
                cancel: function () {
                    // 用户取消分享后执行的回调函数
                }
            };
            wx.onMenuShareAppMessage(shareData);
            wx.onMenuShareTimeline(shareData);
            wx.onMenuShareQQ(shareData);
            wx.onMenuShareWeibo(shareData);
            wx.onMenuShareQZone(shareData);

        });
        wx.error(function (res) {
            alert("config,配置失败")
        });
        //地图点击导航
        $("#navAddress").click(function () {
            console.log(latitude);
            console.log(longitude);
            wx.openLocation({
                latitude: latitude, // 纬度，浮点数，范围为90 ~ -90
                longitude: longitude, // 经度，浮点数，范围为180 ~ -180。
                name: provinceName, // 位置名
                address: address, // 地址详情说明
                scale: 15, // 地图缩放级别,整形值,范围从1~28。默认为最大
                infoUrl: '' // 在查看位置界面底部显示的超链接,可点击跳转
            });
        });

        //获取轮播图
        publicAjax(baseAjaxUrl + "/ty_api/product/picture/getListByProductId", "POST", {
            "productId": productId,
            "pageNum": 1,
            "pageSize": 10
        }, goodsSwiperCall);
        //获取产品基础信息
        publicAjax(baseAjaxUrl + "/ty_api/product/queryBaseInfoById", "POST", {
            "productId": productId
        }, productDetailCall);
        //获取产品套餐
        publicAjax(baseAjaxUrl + "/ty_api/product/package/getListByProductId", "POST", {
            "productId": productId,
            "pageNum": 1,
            "pageSize": 3
        }, productPackageCall);
    });


    $(".share").click(function () {
        if (coverImg == '') {
            layMessage("商家未上传产品海报图片，无法生成分享海报");
            return false;
        }

        //没有绑定手机号时给的提示
        if (!isMobile) {
            layer.open({
                content: str
                , btn: ['继续分享', '前往绑定'],
                yes: function () {
                    /*分享*/
                    htmlCanvas();
                },
                no: function () {
                    location.href = "bindingPhone.html";
                }
            });
        } else {
            htmlCanvas();
        }


    })

    //跳转景点详情
    function jumpProductDetail() {
        location.href = "productDetail.html?productId=" + productId;
    }

    //轮播内容的回调
    function goodsSwiperCall(e) {
        /*用于存放轮播内容*/
        var innerHtml = '';
        if (e.errorCode == 200) {
            var data = e.data.list;
            var pictureList = [];
            sharPicture = baseImgUrl + data[0].pictureUrl + "_small.jpg";
            for (var i = 0; i < data.length; i++) {

                pictureList.push(data[i].pictureUrl);

                innerHtml +=
                    '<div class="swiper-slide">\n' +
                    '   <img src="' + baseImgUrl + data[i].pictureUrl + '.jpg" alt="">\n' +
                    '</div>\n';
            }
            pictureList = JSON.stringify(pictureList);
            innerHtml += '<input type="text" value=\'' + pictureList + '\' style="display: none;" class="hht-picture">';
            $(".swiper-wrapper").html(innerHtml);
            lunbo();
            pictureSwiper();
        }
    }

    //产品基础信息的回调
    function productDetailCall(e) {
        /*用于存放内容*/
        if (e.errorCode == 200) {
            var data = e.data;
            productCategoryId = data.productCategoryId;
            console.log(data);
            $("#productBaseName").text(data.productName);
            $("#productBaseInfo").text(data.productTitle);
            $("#productBaseAdd").text(data.address);

            //分享海报相关——商家上传的海报图片
            coverImg = data.coverImg;
            var imgurl = baseImgUrl + data.coverImg + ".jpg";
            $("#shareImg img").attr("src", imgurl);

            latitude = data.latitude; // 纬度，浮点数，范围为90 ~ -90
            longitude = data.longitude; // 经度，浮点数，范围为180 ~ -180。
            provinceName = data.provinceName;
            address = data.address;
            sharProductName = data.productName;
            sharProductTitle = data.productTitle;
            //点击同类和附近的更多
            $("#moreSimilar").attr("href", "moreSimilarProduct.html?productCategoryId=" + productCategoryId + "&productId=" + productId);
            $("#moreNear").attr("href", "moreNearProduct.html?productId=" + productId);

            //查看是否收藏
            var token = getLocal("token");
            $.ajax({
                beforeSend: function (xhr) {
                    //发送ajax请求之前向http的head里面加入验证信息
                    xhr.setRequestHeader("token", token); // 请求发起前在头部附加token
                },
                url: baseAjaxUrl + "/ty_api/product/collection/isCollection",
                type: "POST",
                data: {"productId": data.productId},
                async: false,
                success: function (e) {
                    if (e.errorCode == 200) {
                        if (e.data.isCollection == 0) {
                            $("#currentCollectFlag").attr("src", "static/img/goods/collection@2x.png");
                            $("#currentCollectFlag").attr("data-collection", "0");
                        } else if (e.data.isCollection == 1) {
                            $("#currentCollectFlag").attr("src", "static/img/goods/collection2@2x.png");
                            $("#currentCollectFlag").attr("data-collection", "1");
                        }
                    }
                },
                error: function (res) {
                    // alert("您访问的服务器被外星人抓走了")
                }
            });
        }

        //获取同类推荐产品
//        console.log(productCategoryId);
        publicAjax(baseAjaxUrl + "/ty_api/product/queryProductByCategoryId", "POST", {
            "productId": productId,
            "longitude": longitude,
            "latitude": latitude,
            "productCategory": productCategoryId,
            "pageNum": 1,
            "pageSize": 3
        }, similarProductCall);

        //获取同类推荐产品
        publicAjax(baseAjaxUrl + "/ty_api/product/queryByAddress", "POST", {
            "productId": productId,
            "longitude": longitude,
            "latitude": latitude,
            "pageNum": 1,
            "pageSize": 3
        }, nearProductCall);

    }

    //产品套餐的回调
    function productPackageCall(e) {
        /*用于存放内容*/
        var innerHtml = '';
        if (e.errorCode == 200) {
            var data = e.data.list;
            for (var i = 0; i < data.length; i++) {
                var refunds = '';
                if (data[i].refundType == "NO_REFUND") {
                    refunds = "概不退款";
                } else {
                    refunds = "条件退";
                }
                if (clientId == null) {
                    var ticketFlag =
                        '        <p class="ticket-flag">\n' +
                        '               <span><i>推</i><i>￥' + data[i].defaultAgentCommission + '</i></span>' +
                        '               <span><i>享</i><i>￥' + data[i].defaultSaleCommission + '</i></span>' +
                        '        </p>\n';
                } else {
                    var ticketFlag = "";
                }
                innerHtml +=
                    '<div class="ticket-item" data-packageId="' + data[i].productPackageId + '">\n' +
                    '   <div class="ticket-item-left">\n' +
                    '        <p class="ticket-item-title">' + data[i].packageName + '</p>\n' +
                    ticketFlag +
                    '   </div>\n' +
                    '   <div class="ticket-item-right">\n' +
                    '        <p class="present-price"><span>￥</span>' + data[i].salePrice + '</p>\n' +
                    '        <p class="reservation" data-old="' + data[i].retailPrice + '" data-present="' + data[i].salePrice + '" data-endsale="' + data[i].endSale + '" data-startTime="' + data[i].startDate + '" data-endTime="' + data[i].endDate + '" data-packageId="' + data[i].productPackageId + '">预定</p>\n' +
                    '    </div>\n' +
                    '</div>';
            }
            $(".ticket-con").html(innerHtml);
            setPackage();
        } else if (e.errorCode == 530) {
            //信息框
            layer.open({
                content: '产品已下架'
                , btn: '看看别的',
                yes: function () {
                    location.href = "index.html";
                }
            });
        }
    }

    /*票务的下转箭头*/
    var arrowFlag = true;
    $(".arrow").click(function () {
        if (arrowFlag) {
            $(this).css("transform", "Rotate(180deg)");
            $(".ticket-con").slideUp(500);
            arrowFlag = !arrowFlag;
        } else {
            $(this).css("transform", "Rotate(0)");
            $(".ticket-con").slideDown(500);
            arrowFlag = !arrowFlag;
        }
    });

    //产品页banner上的收藏
    function currentCollect(e) {
        var collectionIsFlag = $(e).attr("data-collection");
        //进行收藏
        if (collectionIsFlag == "0") {
            publicAjaxToken(baseAjaxUrl + "/ty_api/product/collection/doCollection", "POST", {
                "productId": productId
            }, doCollectionCall);
        } else if (collectionIsFlag == "1") {     //取消收藏
            publicAjaxToken(baseAjaxUrl + "/ty_api/product/collection/cancelCollection", "POST", {
                "productId": productId
            }, cancelCollectionCall);
        }
    }

    //产品页banner上进行收藏的回调
    function doCollectionCall(e) {
        if (e.errorCode == 201) {
            deleteCookie("token");
            getToken();
            publicAjaxToken(baseAjaxUrl + "/ty_api/product/collection/doCollection", "POST", {
                "productId": productId
            }, doCollectionCall);
        } else if (e.errorCode == 200) {
            layMessage(e.message);
            $("#currentCollectFlag").attr("src", "static/img/goods/collection2@2x.png");
            $("#currentCollectFlag").attr("data-collection", "1");
        } else {
            layMessage(e.message);
        }
    }

    //产品页banner上取消收藏的回调
    function cancelCollectionCall(e) {
        if (e.errorCode == 201) {
            deleteCookie("token");
            getToken();
            publicAjaxToken(baseAjaxUrl + "/ty_api/product/collection/cancelCollection", "POST", {
                "productId": productId
            }, cancelCollectionCall);
        } else if (e.errorCode == 200) {
            layMessage(e.message);
            $("#currentCollectFlag").attr("src", "static/img/goods/collection@2x.png");
            $("#currentCollectFlag").attr("data-collection", "0");
        } else {
            layMessage(e.message);
        }

    }

    //点击预定的页面跳转
    function setPackage() {

        $(".ticket-item").each(function (i, v) {
            $(v).click(function () {
                var productPackageId = $(v).attr("data-packageId");
                console.log("这是clientid" + clientId);
                if (clientId) {

                    /*为迎合ios所以productPackageId必须放在最后*/
                    if (endId) {
                        location.href = "packageDetail.html?clientId=" + clientId + "&endId=" + endId + "&productId=" + productId + "&productPackageId=" + productPackageId;
                    } else {
                        location.href = "packageDetail.html?clientId=" + clientId + "&productId=" + productId + "&productPackageId=" + productPackageId;
                    }

                } else {
                    // location.href = "packageDetail.html?productPackageId=" + productPackageId + "&productId=" + productId;
                    location.href = "packageDetail.html?productId=" + productId + "&productPackageId=" + productPackageId;
                }

            })
        })

    }


    //封装产品同类推荐的回调
    function similarProductCall(e) {
        /*用于存放内容*/
        var innerHtml = '';
        if (e.errorCode == 200) {
            var data = e.data.list;
            // var collectionImg = '';
            for (var i = 0; i < data.length; i++) {
                var tagInnerHtml = ''; //标签
                var starsHtml = '';    //星星的img标签
                if (data[i].tags[0] != null) {
                    for (var j = 0; j < data[i].tags.length; j++) {
                        tagInnerHtml += '<span>' + data[i].tags[j] + '</span>';
                    }
                } else {
                    tagInnerHtml += '暂无标签';
                }

                //循环收藏
                // var token = getLocal("token");
                // $.ajax({
                //     contentType: "application/x-www-form-urlencoded; charset=utf-8",
                //     beforeSend: function (xhr) {
                //         //发送ajax请求之前向http的head里面加入验证信息
                //         xhr.setRequestHeader("token", token); // 请求发起前在头部附加token
                //     },
                //     url: baseAjaxUrl + "/ty_api/product/collection/isCollection",
                //     type: "POST",
                //     data: {"productId": data[i].productId},
                //     async: false,
                //     success: function (e) {
                //         if (e.errorCode == 200) {
                //             if (e.data.isCollection == 0) {
                //                 collectionImg = '<img src="static/img/public/collection2@2x.png" alt="" class="collection" onclick="collectionFlag(this)" data-collection="0" data-productId="' + data[i].productId + '">'
                //             } else if (e.data.isCollection == 1) {
                //                 collectionImg = '<img src="static/img/public/collection3@2x.png" alt="" class="collection" onclick="collectionFlag(this)" data-collection="1" data-productId="' + data[i].productId + '">'
                //             }
                //         }
                //     },
                //     error: function (res) {
                //         alert("您访问的服务器被外星人抓走了")
                //     }
                // });


                //星星评分
                var solidStars = data[i].score;
                var emptyStars = starsLevel - solidStars;
                for (var j = 0; j < solidStars; j++) {
                    starsHtml += '<img src="static/img/goods/stars2@3x.png" alt="">';
                }
                for (var n = 0; n < emptyStars; n++) {
                    starsHtml += '<img src="static/img/goods/stars@3x.png" alt="">';
                }

                //主体
                innerHtml +=
                    '<div class="hot-item">\n' +
                    '   <a href="goods.html?productId=' + data[i].productId + '">\n' +
                    '       <div class="hot-left">\n' +
                    '           <img src="' + baseImgUrl + data[i].pictureUrl + '_small.jpg" alt="">\n' +
                    '        </div>\n' +
                    '   </a>\n' +
                    '   <div class="hot-right">\n' +
                    '       <a href="goods.html?productId=' + data[i].productId + '">\n' +
                    '           <div class="hot-p">\n' +
                    '               <p class="hot-title">' + data[i].productName + '</p>\n' +
                    '               <p class="hot-tag">' + tagInnerHtml + '</p>\n' +
                    '               <p class="hot-stars">\n' +
                    '                   <span class="stars">' + starsHtml + '</span>\n' +
                    '                   <span>' + (data[i].commentNum == null ? "0" : data[i].commentNum) + '条评论</span>\n' +
                    '               </p>\n' +
                    '               <p class="hot-detail">' + data[i].productAddress + ' | ' + data[i].distance + 'km</p>\n' +
                    '           </div>\n' +
                    '       </a>\n' +
                    '       <div class="hot-icon"><p><span>￥</span>' + data[i].minPrice + '</p>\n' +
                    '       </div>\n' +
                    '   </div>\n' +
                    '</div>';
            }
            $("#similarProduct").html(innerHtml);
        }
    }

    //封装产品附近推荐的回调
    function nearProductCall(e) {
        /*用于存放内容*/
        var innerHtml = '';
        if (e.errorCode == 200) {
            var data = e.data.list;
            // var collectionImg = '';
            for (var i = 0; i < data.length; i++) {
                var tagInnerHtml = '';  //标签
                var starsHtml = '';     //星星的img标签
                if (data[i].tags[0] != null) {
                    for (var j = 0; j < data[i].tags.length; j++) {
                        tagInnerHtml += '<span>' + data[i].tags[j] + '</span>';
                    }
                } else {
                    tagInnerHtml += '<p style="color:#ddd;">暂无标签</p>';
                }

                //循环收藏
                // var token = getLocal("token");
                // $.ajax({
                //     contentType: "application/x-www-form-urlencoded; charset=utf-8",
                //     beforeSend: function (xhr) {
                //         //发送ajax请求之前向http的head里面加入验证信息
                //         xhr.setRequestHeader("token", token); // 请求发起前在头部附加token
                //     },
                //     url: baseAjaxUrl + "/ty_api/product/collection/isCollection",
                //     type: "POST",
                //     data: {"productId": data[i].productId},
                //     async: false,
                //     success: function (e) {
                //         if (e.errorCode == 200) {
                //             if (e.data.isCollection == 0) {
                //                 collectionImg = '<img src="static/img/public/collection2@2x.png" alt="" class="collection" onclick="collectionFlag(this)" data-collection="0" data-productId="' + data[i].productId + '">';
                //             } else if (e.data.isCollection == 1) {
                //                 collectionImg = '<img src="static/img/public/collection3@2x.png" alt="" class="collection" onclick="collectionFlag(this)" data-collection="1" data-productId="' + data[i].productId + '">';
                //             }
                //         }
                //     },
                //     error: function (res) {
                //         alert("您访问的服务器被外星人抓走了")
                //     }
                // });

                //星星评分
                var solidStars = data[i].score;
                var emptyStars = starsLevel - solidStars;
                for (var j = 0; j < solidStars; j++) {
                    starsHtml += '<img src="static/img/goods/stars2@3x.png" alt="">';
                }
                for (var n = 0; n < emptyStars; n++) {
                    starsHtml += '<img src="static/img/goods/stars@3x.png" alt="">';
                }

                innerHtml +=
                    '<div class="hot-item">\n' +
                    '   <a href="goods.html?productId=' + data[i].productId + '">\n' +
                    '       <div class="hot-left">\n' +
                    '           <img src="' + baseImgUrl + data[i].pictureUrl + '_small.jpg" alt="">\n' +
                    '        </div>\n' +
                    '   </a>\n' +
                    '   <div class="hot-right">\n' +
                    '       <a href="goods.html?productId=' + data[i].productId + '">\n' +
                    '           <div class="hot-p">\n' +
                    '               <p class="hot-title">' + data[i].productName + '</p>\n' +
                    '               <p class="hot-tag">' + tagInnerHtml + '</p>\n' +
                    '               <p class="hot-stars">\n' +
                    '                   <span class="stars">' + starsHtml + '</span>\n' +
                    '                   <span>' + (data[i].commentNum == null ? "0" : data[i].commentNum) + '条评论</span>\n' +
                    '               </p>\n' +
                    '               <p class="hot-detail">' + data[i].productAddress + ' | ' + data[i].distance + 'km</p>\n' +
                    '           </div>\n' +
                    '       </a>\n' +
                    '       <div class="hot-icon"><p><span>￥</span>' + data[i].minPrice + '</p>\n' +
                    '       </div>\n' +
                    '   </div>\n' +
                    '</div>';
            }
            $("#nearProduct").html(innerHtml);
        }
    }

    /*推荐的产品点击收藏时的函数*/
    function collectionFlag(e) {
        var token = getLocal("token");
        var collectionIsFlag = $(e).attr("data-collection");
        var productId = $(e).attr("data-productId");
        if (collectionIsFlag == "0") {//无——》有
            $.ajax({
                beforeSend: function (xhr) {
                    //发送ajax请求之前向http的head里面加入验证信息
                    xhr.setRequestHeader("token", token); // 请求发起前在头部附加token
                },
                url: baseAjaxUrl + "/ty_api/product/collection/doCollection",
                type: "POST",
                data: {"productId": productId},
                success: function (res) {
                    if (res.errorCode == 200) {
                        layMessage(res.message);
                        $(e).attr("src", "static/img/public/collection3@2x.png");
                        $(e).attr("data-collection", "1");
                    }
                },
                error: function (res) {
                    // alert("您访问的服务器被外星人抓走了")
                }
            })
        } else if (collectionIsFlag == "1") {//有——》无
            $.ajax({
                beforeSend: function (xhr) {
                    //发送ajax请求之前向http的head里面加入验证信息
                    xhr.setRequestHeader("token", token); // 请求发起前在头部附加token
                },
                url: baseAjaxUrl + "/ty_api/product/collection/cancelCollection",
                type: "POST",
                data: {"productId": productId},
                success: function (res) {
                    if (res.errorCode == 200) {
                        layMessage(res.message);
                        $(e).attr("src", "static/img/public/collection2@2x.png");
                        $(e).attr("data-collection", "0");
                    }
                },
                error: function (res) {
                    // alert("您访问的服务器被外星人抓走了")
                }
            })
        }
    }

    /*点击图片列表*/
    function pictureSwiper() {

        $("#goodsImg").click(function () {
            var pritureList = JSON.parse($(this).children("input").val());
            console.log(pritureList);
            var swiperCon = '';
            if (pritureList.length == 0) {
                return false;
            }
            for (var i = 0; i < pritureList.length; i++) {
                swiperCon +=
                    '   <div class="swiper-slide">\n' +
                    '       <img src="' + baseImgUrl + pritureList[i] + '_small.jpg" alt="">\n' +
                    '   </div>\n';
            }
            layer.open({
                type: 1
                ,
                className: "goods-img",
                content:
                '   <div class="swiper-container">\n' +
                '       <div class="swiper-wrapper">' +
                swiperCon +
                '       </div>\n' +
                '       <div class="swiper-pagination"></div>\n' +
                '   </div>' +
                '<img src="static/img/public/close@2x.png" alt="" class="close">'
                ,
                anim: 'scale'
                ,
                style: 'position:fixed; bottom:0; left:0;top:0;right:0; width: 100%;padding:10px 0; border:none;background: rgba(0, 0, 0, 0.1);',
                success: function () {
                    var swiper = new Swiper('.swiper-container', {
                        loop: false,
                        autoplay: false,
                        pagination: {
                            el: '.swiper-pagination',
                            type: 'fraction',
                        },
                    });
                    $(".close").click(function () {
                        layer.closeAll()
                    })
                }
            });
        })

    }
</script>
